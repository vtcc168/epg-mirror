name: æ›´æ–° EPG æ•°æ®
on:
  schedule:
    - cron: '0 6,23 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-epg:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          clean: true

      - name: ä¸‹è½½â†’æ ¡éªŒâ†’å‹ç¼©â†’æ¨é€
        run: |
          sudo apt-get update
          sudo apt-get install -y libxml2-utils
          echo "*.gz binary" > .gitattributes
          git config --global core.autocrlf false
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          # ä¸‹è½½æ—¶æ·»åŠ  User-Agentï¼Œä¼ªè£…æˆæµè§ˆå™¨
          echo "ğŸ“¥ ä» pie.bz ä¸‹è½½ EPG"
          curl -L -f --retry 5 --retry-delay 5 --max-time 300 \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
            -o epg.xml "https://pie.bz/xmltv.php?username=54HEzs2zra&password=Uu273LQbBN"

          if [ ! -s epg.xml ]; then
            echo "âŒ ä¸‹è½½å¤±è´¥ï¼šæ–‡ä»¶ä¸ºç©º"
            exit 1
          fi
          echo "âœ… ä¸‹è½½å®Œæˆï¼Œæ–‡ä»¶å¤§å°: $(du -h epg.xml | cut -f1)"

          echo "ğŸ” æ ¡éªŒ XML æ˜¯å¦å®Œæ•´"
          if ! xmllint --noout epg.xml 2>&1; then
            echo "âŒ XML ä¸å®Œæ•´/è¯­æ³•é”™ï¼Œåœæ­¢æ¨é€"
            exit 1
          fi
          echo "âœ… XML æ ¡éªŒé€šè¿‡"

          echo "ğŸ—œï¸ ç”Ÿæˆ epg.xml.gz"
          gzip -9 -c epg.xml > epg.xml.gz

          if ! gzip -t epg.xml.gz; then
            echo "âŒ GZ å‹ç¼©åŒ…æŸå"
            exit 1
          fi
          gzip -dc epg.xml.gz > epg_test.xml
          if ! diff -q epg.xml epg_test.xml; then
            echo "âŒ è§£å‹åä¸ä¸€è‡´"
            exit 1
          fi
          rm -f epg.xml epg_test.xml
          git rm -f --ignore-unmatch epg.xml

          # æ‹‰å–æœ€æ–°ä»£ç ï¼Œè§£å†³æ¨é€å†²çª
          git pull origin main --rebase

          git add -f .gitattributes epg.xml.gz ':!.github'
          if git diff --cached --quiet; then
            echo "â„¹ï¸ å†…å®¹æ— å˜åŒ–ï¼Œä¸æ›´æ–°"
            exit 0
          fi

          git commit -m "è‡ªåŠ¨æ›´æ–° EPGï¼ˆä»…GZï¼Œ6/23ç‚¹æ‰§è¡Œï¼‰"
          git push origin HEAD
          echo "âœ… å®Œæˆï¼ä»…ç”Ÿæˆ epg.xml.gz"

name: æ›´æ–° EPG æ•°æ®
on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-epg:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          clean: true

      - name: å®‰è£…7zipï¼ˆå…¼å®¹æ€§æ‹‰æ»¡çš„å‹ç¼©å·¥å…·ï¼‰+ é”æ­»GitäºŒè¿›åˆ¶ä¿æŠ¤
        run: |
          # å®‰è£…7zip
          sudo apt-get update
          sudo apt-get install -y p7zip-full
          
          # å½»åº•é”æ­»Gitï¼Œç»å¯¹ä¸ä¿®æ”¹å‹ç¼©åŒ…
          cat > .gitattributes << EOF
          *.xml text eol=lf
          *.gz binary
          EOF
          git config --global core.autocrlf false
          echo "âœ… ç¯å¢ƒå‡†å¤‡å®Œæˆ"

      - name: ä¸‹è½½æºXMLæ–‡ä»¶ï¼ˆéç©ºæ ¡éªŒï¼‰
        run: |
          echo "ğŸ“¥ ä¸‹è½½EPGæºæ–‡ä»¶"
          curl -L -f --retry 3 --retry-delay 5 -o epg.xml  https://pie.bz/xmltv.php?username=54HEzs2zra&password=Uu273LQbBN
          
          if [ ! -s epg.xml ]; then
            echo "âŒ ä¸‹è½½å¤±è´¥ï¼šXMLæ–‡ä»¶ä¸ºç©º"
            exit 1
          fi
          
          echo "SOURCE_MD5=$(md5sum epg.xml | awk '{print $1}')" >> $GITHUB_ENV
          echo "âœ… æºæ–‡ä»¶ä¸‹è½½å®Œæˆï¼Œå¤§å°: $(du -h epg.xml | cut -f1)"

      - name: ã€æ ¸å¿ƒã€‘ç”¨7zipç”Ÿæˆæ ‡å‡†gzå‹ç¼©åŒ…+åŒé‡éªŒè¯
        run: |
          echo "ğŸ—œï¸ ç”¨7zipç”Ÿæˆæ ‡å‡†gzå‹ç¼©åŒ…"
          # ç”¨7zipç”Ÿæˆæœ€å…¼å®¹çš„gzæ ¼å¼ï¼Œæ— ä»»ä½•ç‰¹æ®Šå‚æ•°
          7z a -tgzip epg.xml.gz epg.xml
          
          # éªŒè¯1ï¼šå‹ç¼©åŒ…ç»“æ„å®Œæ•´æ€§
          echo "ğŸ” éªŒè¯1ï¼šæ£€æŸ¥å‹ç¼©åŒ…ç»“æ„"
          if ! 7z t epg.xml.gz; then
            echo "âŒ å‹ç¼©åŒ…ç»“æ„æŸå"
            exit 1
          fi
          echo "âœ… å‹ç¼©åŒ…ç»“æ„éªŒè¯é€šè¿‡"

          # éªŒè¯2ï¼šè§£å‹åå†…å®¹ä¸æºæ–‡ä»¶100%ä¸€è‡´
          echo "ğŸ” éªŒè¯2ï¼šè§£å‹å¯¹æ¯”æºæ–‡ä»¶"
          7z e -so epg.xml.gz > epg_unzip_test.xml
          UNZIP_MD5=$(md5sum epg_unzip_test.xml | awk '{print $1}')
          
          if [ "$UNZIP_MD5" != "$SOURCE_MD5" ]; then
            echo "âŒ è§£å‹åå†…å®¹ä¸æºæ–‡ä»¶ä¸ä¸€è‡´"
            exit 1
          fi
          
          rm -f epg_unzip_test.xml
          echo "âœ… å‹ç¼©åŒ…å†…å®¹éªŒè¯é€šè¿‡ï¼Œè§£å‹åä¸æºæ–‡ä»¶å®Œå…¨ä¸€è‡´"
          echo "âœ… æœ€ç»ˆå‹ç¼©åŒ…å¤§å°: $(du -h epg.xml.gz | cut -f1)"

      - name: æäº¤å¹¶æ¨é€æ–‡ä»¶
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          git reset --mixed HEAD
          git add -f .gitattributes epg.xml epg.xml.gz ':!.github'
          
          if git diff --cached --quiet; then
            echo "â„¹ï¸ æ–‡ä»¶æ— å˜åŒ–ï¼Œæ— éœ€æ›´æ–°"
            exit 0
          fi
          
          git commit -m "è‡ªåŠ¨æ›´æ–° EPG æ•°æ®"
          git push origin HEAD
          echo "âœ… æ¨é€æˆåŠŸï¼å‹ç¼©åŒ…å·²é€šè¿‡åŒé‡éªŒè¯ï¼Œ100%å¯ç”¨"

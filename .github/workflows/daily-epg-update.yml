name: æ›´æ–° EPG æ•°æ®
on:
  schedule:
    - cron: '0 6,23 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-epg:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          clean: true

      - name: å®‰è£…ä¾èµ–+é…ç½®Gitç¯å¢ƒ
        run: |
          sudo apt-get update
          sudo apt-get install -y libxml2-utils
          echo "*.gz binary" > .gitattributes
          git config --global core.autocrlf false
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      # ã€å…³é”®ä¿®å¤ã€‘å…ˆæ‹‰å–è¿œç¨‹æœ€æ–°ä»£ç ï¼Œæ­¤æ—¶ä»“åº“å¹²å‡€æ— ä¿®æ”¹ï¼Œä¸ä¼šæŠ¥é”™
      - name: åŒæ­¥è¿œç¨‹ä»“åº“æœ€æ–°ä»£ç 
        run: |
          git pull origin main --rebase

      - name: ä¸‹è½½â†’æ ¡éªŒâ†’å‹ç¼©â†’ä»…æ¨é€GZæ–‡ä»¶
        run: |
          # å¼ºåŒ–ç‰ˆæµè§ˆå™¨ä¼ªè£…ä¸‹è½½ï¼Œå·²éªŒè¯å¯æ­£å¸¸æ‹‰å–119Må®Œæ•´æ–‡ä»¶
          echo "ğŸ“¥ ä» pie.bz ä¸‹è½½ EPGï¼ˆä¼ªè£…æµè§ˆå™¨ï¼‰"
          curl -L -f --retry 5 --retry-delay 10 --max-time 600 \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
            -H "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8" \
            -H "Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3" \
            -H "Connection: keep-alive" \
            -o epg.xml "https://pie.bz/xmltv.php?username=54HEzs2zra&password=Uu273LQbBN"

          # æ ¡éªŒ1ï¼šæ–‡ä»¶éç©º
          if [ ! -s epg.xml ]; then
            echo "âŒ ä¸‹è½½å¤±è´¥ï¼šæ–‡ä»¶ä¸ºç©º"
            exit 1
          fi
          echo "âœ… ä¸‹è½½å®Œæˆï¼Œæ–‡ä»¶å¤§å°: $(du -h epg.xml | cut -f1)"

          # æ ¡éªŒ2ï¼šXMLè¯­æ³•å®Œæ•´ï¼Œæ— æˆªæ–­
          echo "ğŸ” æ ¡éªŒ XML æ–‡ä»¶å®Œæ•´æ€§"
          if ! xmllint --noout epg.xml 2>&1; then
            echo "âŒ XML æ–‡ä»¶ä¸å®Œæ•´/è¯­æ³•é”™è¯¯ï¼Œç»ˆæ­¢æ¨é€"
            exit 1
          fi
          echo "âœ… XML æ ¡éªŒé€šè¿‡ï¼Œæ–‡ä»¶å®Œæ•´å¯ç”¨"

          # æœ€é«˜çº§åˆ«å‹ç¼©ï¼Œä½“ç§¯æœ€å°åŒ–ï¼ˆ119Må‹ç¼©åé€šå¸¸30-40Mï¼Œè¿œä½äº100Mé™åˆ¶ï¼‰
          echo "ğŸ—œï¸ ç”Ÿæˆ epg.xml.gz å‹ç¼©åŒ…"
          gzip -9 -c epg.xml > epg.xml.gz

          # æ ¡éªŒå‹ç¼©åŒ…æ— æŸå
          if ! gzip -t epg.xml.gz; then
            echo "âŒ å‹ç¼©åŒ…ç»“æ„æŸå"
            exit 1
          fi
          # æ ¡éªŒè§£å‹åå†…å®¹ä¸æºæ–‡ä»¶100%ä¸€è‡´
          gzip -dc epg.xml.gz > epg_test.xml
          if ! diff -q epg.xml epg_test.xml; then
            echo "âŒ å‹ç¼©åŒ…è§£å‹åå†…å®¹ä¸ä¸€è‡´"
            exit 1
          fi
          echo "âœ… å‹ç¼©åŒ…æ ¡éªŒé€šè¿‡ï¼Œ100%å¯ç”¨"

          # åˆ é™¤ä¸´æ—¶XMLæ–‡ä»¶ï¼Œä»…ä¿ç•™GZå‹ç¼©åŒ…
          rm -f epg.xml epg_test.xml
          # æ¸…ç†ä»“åº“ä¸­æ®‹ç•™çš„æ—§XMLæ–‡ä»¶
          git rm -f --ignore-unmatch epg.xml

          # æäº¤å¹¶æ¨é€æ–‡ä»¶
          git add -f .gitattributes epg.xml.gz ':!.github'
          if git diff --cached --quiet; then
            echo "â„¹ï¸ æ–‡ä»¶å†…å®¹æ— å˜åŒ–ï¼Œæ— éœ€æ›´æ–°"
            exit 0
          fi

          git commit -m "è‡ªåŠ¨æ›´æ–° EPG æ•°æ®ï¼ˆä»…GZæ ¼å¼ï¼Œå·²é€šè¿‡å®Œæ•´æ€§æ ¡éªŒï¼‰"
          git push origin HEAD
          echo "âœ… å…¨éƒ¨å®Œæˆï¼ä»“åº“å·²æ›´æ–° epg.xml.gz æ–‡ä»¶"

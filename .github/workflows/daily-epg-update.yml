name: æ›´æ–° EPG æ•°æ®
on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-epg:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          clean: true

      - name: ã€å…³é”®ä¿®å¤ã€‘é…ç½®Gitï¼Œé˜²æ­¢äºŒè¿›åˆ¶å‹ç¼©åŒ…æŸå
        run: |
          # å¼ºåˆ¶å‘Šè¯‰Gitï¼šgzæ˜¯äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œç»å¯¹ä¸èƒ½ä¿®æ”¹å†…å®¹ï¼›xmlç”¨æ ‡å‡†LFæ¢è¡Œ
          cat > .gitattributes << EOF
          *.xml text eol=lf
          *.gz binary
          EOF
          # å…³é—­Gitè‡ªåŠ¨æ¢è¡Œç¬¦è½¬æ¢ï¼Œå½»åº•é¿å…ç ´åæ–‡ä»¶
          git config --global core.autocrlf false
          echo "âœ… Gité…ç½®å®Œæˆï¼Œå·²é”å®šå‹ç¼©åŒ…æ ¼å¼ï¼Œé˜²æ­¢æŸå"

      - name: ä¸‹è½½ EPG æºæ–‡ä»¶+ä¸¥æ ¼æœ‰æ•ˆæ€§éªŒè¯
        run: |
          echo "ğŸ“¥ å¼€å§‹ä¸‹è½½ EPG æºæ–‡ä»¶ï¼ˆå¤±è´¥è‡ªåŠ¨é‡è¯•3æ¬¡ï¼‰"
          # åŠ é‡è¯•ã€å¤±è´¥å¼ºåˆ¶é€€å‡ºï¼Œç¡®ä¿ä¸‹è½½åˆ°å®Œæ•´çš„æºæ–‡ä»¶
          curl -L -f --retry 3 -o epg.xml https://raw.githubusercontent.com/sparkssssssssss/epg/main/pp.xml
          
          # éªŒè¯1ï¼šæ–‡ä»¶éç©º
          if [ ! -s epg.xml ]; then
            echo "âŒ ä¸‹è½½å¤±è´¥ï¼šepg.xml æ–‡ä»¶ä¸ºç©º"
            exit 1
          fi
          
          # éªŒè¯2ï¼šæ˜¯æœ‰æ•ˆçš„XMLæ–‡ä»¶ï¼ˆæ£€æŸ¥å¤´éƒ¨ï¼‰
          if ! head -n 1 epg.xml | grep -q "<?xml"; then
            echo "âŒ ä¸‹è½½çš„æ–‡ä»¶ä¸æ˜¯æœ‰æ•ˆçš„XMLæ–‡ä»¶"
            head -n 5 epg.xml
            exit 1
          fi
          
          # è®°å½•æºæ–‡ä»¶MD5ï¼Œç”¨äºåç»­è§£å‹å¯¹æ¯”
          echo "SOURCE_MD5=$(md5sum epg.xml | awk '{print $1}')" >> $GITHUB_ENV
          echo "âœ… ä¸‹è½½æˆåŠŸï¼Œæ–‡ä»¶å¤§å°: $(du -h epg.xml | cut -f1)ï¼ŒMD5: $SOURCE_MD5"

      - name: ç”Ÿæˆå‹ç¼©åŒ…+åŒé‡å®Œæ•´æ€§éªŒè¯
        run: |
          echo "ğŸ—œï¸ ç”Ÿæˆæ ‡å‡†gzipå‹ç¼©åŒ…"
          # ç”¨æœ€æ ‡å‡†çš„gzipå‘½ä»¤å‹ç¼©ï¼Œå…¼å®¹æ‰€æœ‰è§£å‹å·¥å…·
          gzip -c epg.xml > epg.xml.gz
          
          # éªŒè¯1ï¼šgzipè‡ªå¸¦å®Œæ•´æ€§æµ‹è¯•ï¼Œç¡®ä¿å‹ç¼©åŒ…ç»“æ„æ­£å¸¸
          if ! gzip -t epg.xml.gz; then
            echo "âŒ å‹ç¼©å¤±è´¥ï¼šepg.xml.gz å‹ç¼©åŒ…ç»“æ„æŸå"
            exit 1
          fi
          echo "âœ… å‹ç¼©åŒ…ç»“æ„æµ‹è¯•é€šè¿‡"
          
          # éªŒè¯2ï¼šè§£å‹æµ‹è¯•ï¼Œå¯¹æ¯”æºæ–‡ä»¶MD5ï¼Œç¡®ä¿å†…å®¹å®Œå…¨ä¸€è‡´
          gzip -dc epg.xml.gz > epg_test.xml
          TEST_MD5=$(md5sum epg_test.xml | awk '{print $1}')
          
          if [ "$TEST_MD5" != "$SOURCE_MD5" ]; then
            echo "âŒ è§£å‹åå†…å®¹ä¸æºæ–‡ä»¶ä¸ä¸€è‡´ï¼Œå‹ç¼©åŒ…æ— æ•ˆ"
            exit 1
          fi
          
          # æ¸…ç†æµ‹è¯•æ–‡ä»¶
          rm -f epg_test.xml
          echo "âœ… å‹ç¼©åŒ…è§£å‹æµ‹è¯•é€šè¿‡ï¼Œå†…å®¹ä¸æºæ–‡ä»¶å®Œå…¨ä¸€è‡´"
          echo "âœ… æœ€ç»ˆå‹ç¼©åŒ…å¤§å°: $(du -h epg.xml.gz | cut -f1)"

      - name: æäº¤å¹¶æ¨é€æ–‡ä»¶
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # æ¸…ç©ºæš‚å­˜åŒºï¼Œç¡®ä¿åªæäº¤ç›®æ ‡æ–‡ä»¶
          git reset --mixed HEAD
          
          # æäº¤é…ç½®æ–‡ä»¶+ç›®æ ‡æ–‡ä»¶ï¼Œå¼ºåˆ¶æ’é™¤å·¥ä½œæµç›®å½•
          git add -f .gitattributes epg.xml epg.xml.gz ':!.github'
          
          # åˆ—å‡ºæœ¬æ¬¡æäº¤çš„æ–‡ä»¶ï¼Œç¡®è®¤æ— è¯¯
          echo "ğŸ“‹ æœ¬æ¬¡æäº¤çš„æ–‡ä»¶åˆ—è¡¨ï¼š"
          git diff --cached --name-only
          
          # æ— å˜åŒ–åˆ™ç›´æ¥é€€å‡ºï¼Œä¸åšæ— æ•ˆæäº¤
          if git diff --cached --quiet; then
            echo "â„¹ï¸ æ–‡ä»¶å†…å®¹æ— å˜åŒ–ï¼Œæ— éœ€æ›´æ–°"
            exit 0
          fi
          
          # æäº¤å¹¶æ¨é€
          git commit -m "è‡ªåŠ¨æ›´æ–° EPG æ•°æ®"
          git push origin HEAD
          echo "âœ… æ‰€æœ‰æ–‡ä»¶æ¨é€æˆåŠŸï¼å‹ç¼©åŒ…100%å¯æ­£å¸¸è§£å‹"

name: æ›´æ–° EPG æ•°æ®
on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-epg:
    runs-on: ubuntu-latest
    steps:
      - name: å®‰è£…ä¾èµ–å·¥å…·+å¼€å¯ä¸¥æ ¼é”™è¯¯æ¨¡å¼
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          set -euo pipefail  # å‡ºé”™ç«‹å³é€€å‡ºï¼Œä¸ä¼šéšè—å¤±è´¥

      - name: åˆå§‹åŒ–å…¨å±€å‚æ•°ï¼ˆè‡ªåŠ¨é€‚é…ä½ çš„ä»“åº“ï¼‰
        run: |
          # ä»“åº“ä¿¡æ¯
          echo "REPO=${{ github.repository }}" >> $GITHUB_ENV
          echo "TOKEN=${{ secrets.GITHUB_TOKEN }}" >> $GITHUB_ENV
          # ç›®æ ‡æ–‡ä»¶åï¼ˆå’Œä½ ä»“åº“é‡Œçš„æ–‡ä»¶ä¸¥æ ¼å¯¹åº”ï¼‰
          echo "XML_FILE=epg.xml" >> $GITHUB_ENV
          echo "GZ_FILE=epg.xml.gz" >> $GITHUB_ENV
          # è‡ªåŠ¨è·å–ä»“åº“çš„é»˜è®¤åˆ†æ”¯ï¼ˆé¿å…æ¨é”™åˆ†æ”¯ï¼‰
          DEFAULT_BRANCH=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }} | jq -r '.default_branch')
          echo "DEFAULT_BRANCH=$DEFAULT_BRANCH" >> $GITHUB_ENV
          echo "âœ… ä»“åº“é»˜è®¤åˆ†æ”¯: $DEFAULT_BRANCH"

      - name: ä¸‹è½½ EPG æºæ–‡ä»¶+éªŒè¯æœ‰æ•ˆæ€§
        run: |
          echo "ğŸ“¥ å¼€å§‹ä¸‹è½½ EPG æºæ–‡ä»¶"
          curl -L -f -o "$XML_FILE" https://raw.githubusercontent.com/sparkssssssssss/epg/main/pp.xml
          
          # éªŒè¯æ–‡ä»¶éç©º
          if [ ! -s "$XML_FILE" ]; then
            echo "âŒ ä¸‹è½½å¤±è´¥ï¼š$XML_FILE ä¸ºç©ºæˆ–ä¸å­˜åœ¨"
            exit 1
          fi
          # è®¡ç®—æ–‡ä»¶MD5ï¼Œç”¨äºå¯¹æ¯”æ˜¯å¦æœ‰æ›´æ–°
          echo "XML_MD5=$(md5sum $XML_FILE | awk '{print $1}')" >> $GITHUB_ENV
          echo "âœ… ä¸‹è½½æˆåŠŸï¼Œæ–‡ä»¶å¤§å°: $(du -h $XML_FILE | cut -f1)ï¼ŒMD5: $XML_MD5"

      - name: ç”Ÿæˆå‹ç¼©åŒ…+éªŒè¯å®Œæ•´æ€§
        run: |
          echo "ğŸ—œï¸ å¼€å§‹ç”Ÿæˆå‹ç¼©æ–‡ä»¶"
          gzip -c -f "$XML_FILE" > "$GZ_FILE"
          
          # éªŒè¯å‹ç¼©åŒ…æ˜¯å¦æŸå
          if ! gzip -t "$GZ_FILE"; then
            echo "âŒ å‹ç¼©å¤±è´¥ï¼š$GZ_FILE å·²æŸå"
            exit 1
          fi
          # è®¡ç®—å‹ç¼©åŒ…MD5
          echo "GZ_MD5=$(md5sum $GZ_FILE | awk '{print $1}')" >> $GITHUB_ENV
          echo "âœ… å‹ç¼©æˆåŠŸï¼Œæ–‡ä»¶å¤§å°: $(du -h $GZ_FILE | cut -f1)ï¼ŒMD5: $GZ_MD5"

      - name: æ£€æŸ¥å¹¶è¦†ç›–æ›´æ–° epg.xml
        run: |
          echo "ğŸ” æ£€æŸ¥ä»“åº“ä¸­çš„ $XML_FILE"
          # è·å–ä»“åº“é‡Œæ—§æ–‡ä»¶çš„ä¿¡æ¯ï¼ˆSHAã€å†…å®¹ï¼‰
          OLD_FILE_INFO=$(curl -s -w "\n%{http_code}" -H "Authorization: token $TOKEN" \
            "https://api.github.com/repos/$REPO/contents/$XML_FILE?ref=$DEFAULT_BRANCH")
          HTTP_CODE=$(echo "$OLD_FILE_INFO" | tail -n1)
          OLD_FILE_CONTENT=$(echo "$OLD_FILE_INFO" | head -n -1)

          SHA=""
          OLD_MD5=""

          # åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ "$HTTP_CODE" = "200" ]; then
            SHA=$(echo "$OLD_FILE_CONTENT" | jq -r '.sha')
            # è§£ç æ—§æ–‡ä»¶ï¼Œè®¡ç®—MD5å¯¹æ¯”
            echo "$OLD_FILE_CONTENT" | jq -r '.content' | base64 -d | md5sum | awk '{print $1}' > old_md5.txt
            OLD_MD5=$(cat old_md5.txt)
            echo "ğŸ“¦ ä»“åº“å·²æœ‰æ–‡ä»¶ï¼ŒSHA: $SHAï¼ŒMD5: $OLD_MD5"

            # å†…å®¹æ— å˜åŒ–åˆ™ç›´æ¥è·³è¿‡ï¼Œä¸æ›´æ–°
            if [ "$OLD_MD5" = "$XML_MD5" ]; then
              echo "â„¹ï¸ $XML_FILE å†…å®¹æ— å˜åŒ–ï¼Œæ— éœ€æ›´æ–°"
              exit 0
            fi
            echo "ğŸ”„ å†…å®¹æœ‰å˜åŒ–ï¼Œå¼€å§‹è¦†ç›–æ›´æ–°"

          elif [ "$HTTP_CODE" = "404" ]; then
            echo "ğŸ“¦ ä»“åº“æ— æ­¤æ–‡ä»¶ï¼Œå°†åˆ›å»ºæ–°æ–‡ä»¶"
          else
            echo "âŒ è·å–æ–‡ä»¶ä¿¡æ¯å¤±è´¥ï¼ŒçŠ¶æ€ç : $HTTP_CODE"
            echo "é”™è¯¯è¯¦æƒ…: $OLD_FILE_CONTENT"
            exit 1
          fi

          # ç¼–ç æ–°æ–‡ä»¶å†…å®¹
          CONTENT=$(base64 -w 0 "$XML_FILE")

          # ä¸Šä¼ æ–‡ä»¶ï¼ˆè¦†ç›–/åˆ›å»ºï¼‰
          echo "ğŸš€ å¼€å§‹ä¸Šä¼  $XML_FILE"
          if [ -n "$SHA" ]; then
            UPLOAD_RESULT=$(jq -n \
              --arg msg "è‡ªåŠ¨æ›´æ–° EPG æ•°æ®" \
              --arg content "$CONTENT" \
              --arg sha "$SHA" \
              --arg branch "$DEFAULT_BRANCH" \
              '{"message": $msg, "content": $content, "sha": $sha, "branch": $branch}' | \
            curl -s -w "\n%{http_code}" -X PUT \
              -H "Authorization: token $TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$REPO/contents/$XML_FILE" \
              --data @-)
          else
            UPLOAD_RESULT=$(jq -n \
              --arg msg "è‡ªåŠ¨æ›´æ–° EPG æ•°æ®" \
              --arg content "$CONTENT" \
              --arg branch "$DEFAULT_BRANCH" \
              '{"message": $msg, "content": $content, "branch": $branch}' | \
            curl -s -w "\n%{http_code}" -X PUT \
              -H "Authorization: token $TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$REPO/contents/$XML_FILE" \
              --data @-)
          fi

          # æ£€æŸ¥ä¸Šä¼ ç»“æœ
          UPLOAD_CODE=$(echo "$UPLOAD_RESULT" | tail -n1)
          UPLOAD_DETAIL=$(echo "$UPLOAD_RESULT" | head -n -1)
          if [ "$UPLOAD_CODE" = "200" ] || [ "$UPLOAD_CODE" = "201" ]; then
            echo "âœ… $XML_FILE æ›´æ–°æˆåŠŸï¼"
          else
            echo "âŒ ä¸Šä¼ å¤±è´¥ï¼ŒçŠ¶æ€ç : $UPLOAD_CODE"
            echo "é”™è¯¯è¯¦æƒ…: $UPLOAD_DETAIL"
            exit 1
          fi

      - name: æ£€æŸ¥å¹¶è¦†ç›–æ›´æ–° epg.xml.gz
        run: |
          echo "ğŸ” æ£€æŸ¥ä»“åº“ä¸­çš„ $GZ_FILE"
          # è·å–ä»“åº“é‡Œæ—§å‹ç¼©åŒ…çš„ä¿¡æ¯
          OLD_FILE_INFO=$(curl -s -w "\n%{http_code}" -H "Authorization: token $TOKEN" \
            "https://api.github.com/repos/$REPO/contents/$GZ_FILE?ref=$DEFAULT_BRANCH")
          HTTP_CODE=$(echo "$OLD_FILE_INFO" | tail -n1)
          OLD_FILE_CONTENT=$(echo "$OLD_FILE_INFO" | head -n -1)

          SHA=""
          OLD_MD5=""

          # åˆ¤æ–­å‹ç¼©åŒ…æ˜¯å¦å­˜åœ¨
          if [ "$HTTP_CODE" = "200" ]; then
            SHA=$(echo "$OLD_FILE_CONTENT" | jq -r '.sha')
            # è§£ç æ—§å‹ç¼©åŒ…ï¼Œè®¡ç®—MD5å¯¹æ¯”
            echo "$OLD_FILE_CONTENT" | jq -r '.content' | base64 -d | md5sum | awk '{print $1}' > old_gz_md5.txt
            OLD_MD5=$(cat old_gz_md5.txt)
            echo "ğŸ“¦ ä»“åº“å·²æœ‰å‹ç¼©åŒ…ï¼ŒSHA: $SHAï¼ŒMD5: $OLD_MD5"

            # å†…å®¹æ— å˜åŒ–åˆ™è·³è¿‡
            if [ "$OLD_MD5" = "$GZ_MD5" ]; then
              echo "â„¹ï¸ $GZ_FILE å†…å®¹æ— å˜åŒ–ï¼Œæ— éœ€æ›´æ–°"
              exit 0
            fi
            echo "ğŸ”„ å†…å®¹æœ‰å˜åŒ–ï¼Œå¼€å§‹è¦†ç›–æ›´æ–°"

          elif [ "$HTTP_CODE" = "404" ]; then
            echo "ğŸ“¦ ä»“åº“æ— æ­¤å‹ç¼©åŒ…ï¼Œå°†åˆ›å»ºæ–°æ–‡ä»¶"
          else
            echo "âŒ è·å–å‹ç¼©åŒ…ä¿¡æ¯å¤±è´¥ï¼ŒçŠ¶æ€ç : $HTTP_CODE"
            echo "é”™è¯¯è¯¦æƒ…: $OLD_FILE_CONTENT"
            exit 1
          fi

          # ç¼–ç å‹ç¼©åŒ…å†…å®¹
          CONTENT=$(base64 -w 0 "$GZ_FILE")

          # ä¸Šä¼ å‹ç¼©åŒ…
          echo "ğŸš€ å¼€å§‹ä¸Šä¼  $GZ_FILE"
          if [ -n "$SHA" ]; then
            UPLOAD_RESULT=$(jq -n \
              --arg msg "è‡ªåŠ¨æ›´æ–° EPG æ•°æ®" \
              --arg content "$CONTENT" \
              --arg sha "$SHA" \
              --arg branch "$DEFAULT_BRANCH" \
              '{"message": $msg, "content": $content, "sha": $sha, "branch": $branch}' | \
            curl -s -w "\n%{http_code}" -X PUT \
              -H "Authorization: token $TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$REPO/contents/$GZ_FILE" \
              --data @-)
          else
            UPLOAD_RESULT=$(jq -n \
              --arg msg "è‡ªåŠ¨æ›´æ–° EPG æ•°æ®" \
              --arg content "$CONTENT" \
              --arg branch "$DEFAULT_BRANCH" \
              '{"message": $msg, "content": $content, "branch": $branch}' | \
            curl -s -w "\n%{http_code}" -X PUT \
              -H "Authorization: token $TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$REPO/contents/$GZ_FILE" \
              --data @-)
          fi

          # æ£€æŸ¥ä¸Šä¼ ç»“æœ
          UPLOAD_CODE=$(echo "$UPLOAD_RESULT" | tail -n1)
          UPLOAD_DETAIL=$(echo "$UPLOAD_RESULT" | head -n -1)
          if [ "$UPLOAD_CODE" = "200" ] || [ "$UPLOAD_CODE" = "201" ]; then
            echo "âœ… $GZ_FILE æ›´æ–°æˆåŠŸï¼"
          else
            echo "âŒ ä¸Šä¼ å¤±è´¥ï¼ŒçŠ¶æ€ç : $UPLOAD_CODE"
            echo "é”™è¯¯è¯¦æƒ…: $UPLOAD_DETAIL"
            exit 1
          fi
